@page "/talon-import"
@using Microsoft.AspNetCore.Components.Forms
@inject VoiceLauncherWasm.Services.IIndexedDBService IndexedDBService
@inject VoiceLauncherWasm.Services.TalonParserService TalonParserService

<h2>Import Talon Scripts (client)</h2>
<p class="text-muted">Upload .talon files and import directly into the client-side IndexedDB store.</p>

<div class="mb-3">
    <InputFile OnChange="OnFileSelected" multiple accept=".talon" class="form-control" />
</div>
<button class="btn btn-primary" @onclick="ImportFiles" disabled="@(selectedFiles == null || !selectedFiles.Any())">Import</button>

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-info mt-3">@message</div>
}

@code {
    private List<IBrowserFile> selectedFiles = new();
    private string message = string.Empty;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFiles = e.GetMultipleFiles(50).ToList();
    }

    private async Task ImportFiles()
    {
        if (!selectedFiles.Any()) return;
        await IndexedDBService.InitializeAsync();
        int count = 0;
        foreach (var file in selectedFiles)
        {
            using var stream = file.OpenReadStream(1024 * 1024);
            using var reader = new StreamReader(stream);
            var content = await reader.ReadToEndAsync();
            var commands = TalonParserService.ParseTalonFile(content, file.Name, null);
            foreach (var cmd in commands)
            {
                await IndexedDBService.AddCommandAsync(cmd);
                count++;
            }
        }
        message = $"Imported {count} commands to local IndexedDB.";
        selectedFiles.Clear();
    }
}
